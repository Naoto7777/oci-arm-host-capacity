name: Create OCI Instance

on:
  schedule:
    - cron: '*/10 * * * *'  # 10分ごと実行
  workflow_dispatch:  # 手動実行も可能

jobs:
  create-instance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        
    - name: Install dependencies
      run: composer install --no-dev --prefer-dist
      
    - name: Create .env file
      run: |
        echo "OCI_REGION=${{ secrets.OCI_REGION }}" >> .env
        echo "OCI_USER_ID=${{ secrets.OCI_USER_ID }}" >> .env
        echo "OCI_TENANCY_ID=${{ secrets.OCI_TENANCY_ID }}" >> .env
        echo "OCI_KEY_FINGERPRINT=${{ secrets.OCI_KEY_FINGERPRINT }}" >> .env
        echo "OCI_PRIVATE_KEY_FILENAME=${{ secrets.OCI_PRIVATE_KEY_FILENAME }}" >> .env
        echo "OCI_SUBNET_ID=${{ secrets.OCI_SUBNET_ID }}" >> .env
        echo "OCI_IMAGE_ID=${{ secrets.OCI_IMAGE_ID }}" >> .env
        echo "OCI_OCPUS=${{ secrets.OCI_OCPUS }}" >> .env
        echo "OCI_MEMORY_IN_GBS=${{ secrets.OCI_MEMORY_IN_GBS }}" >> .env
        echo "OCI_SHAPE=${{ secrets.OCI_SHAPE }}" >> .env
        echo "OCI_MAX_INSTANCES=${{ secrets.OCI_MAX_INSTANCES }}" >> .env
        echo "OCI_SSH_PUBLIC_KEY=\"${{ secrets.OCI_SSH_PUBLIC_KEY }}\"" >> .env
        echo "OCI_AVAILABILITY_DOMAIN=" >> .env
        echo "CACHE_AVAILABILITY_DOMAINS=${{ secrets.CACHE_AVAILABILITY_DOMAINS }}" >> .env
        echo "OCI_BOOT_VOLUME_SIZE_IN_GBS=${{ secrets.OCI_BOOT_VOLUME_SIZE_IN_GBS }}" >> .env
        
    - name: Run script
      run: php index.php
